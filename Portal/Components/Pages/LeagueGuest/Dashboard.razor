@page "/guest/league/{leagueId:guid}"
@attribute [Authorize(Roles = "LeagueGuest")]
@using Application.Services
@inject IAuctionQueries AuctionQueries
@inject Portal.Auth.IMagicGrantAccessor GrantAccessor

<PageTitle>Dashboard Ospite</PageTitle>

<RadzenRow Gap="2rem" Class="rz-p-4">
    <RadzenColumn Size="12">
        <RadzenCard>
            <RadzenStack>
                <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1">
                    üëÄ Dashboard Ospite
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-color-secondary">
                    Osserva lo stato della lega e le aste in tempo reale
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<!-- Stato della Lega -->
<RadzenRow Gap="2rem" Class="rz-p-4">
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <RadzenStack>
                <RadzenText TextStyle="TextStyle.H5">
                    üèÜ Stato Lega
                </RadzenText>
                
                @if (leagueInfo != null)
                {
                    <RadzenText TextStyle="TextStyle.Body1">
                        <strong>Nome:</strong> @leagueInfo.Name
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">
                        <strong>Squadre:</strong> @leagueInfo.Teams.Count
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">
                        <strong>Budget Totale:</strong> @leagueInfo.TotalBudget
                    </RadzenText>
                }
                else
                {
                    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>

    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <RadzenStack>
                <RadzenText TextStyle="TextStyle.H5">
                    ‚öΩ Asta Corrente
                </RadzenText>
                
                @if (currentAuction != null)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Success" ShowIcon="true">
                        <RadzenText>
                            <strong>Asta in corso:</strong> @currentAuction.Status
                        </RadzenText>
                    </RadzenAlert>
                    
                    <RadzenText TextStyle="TextStyle.Body1">
                        <strong>Turno:</strong> @currentAuction.CurrentTurnPosition / @currentAuction.TotalTeams
                    </RadzenText>
                    
                    <RadzenText TextStyle="TextStyle.Body1">
                        <strong>Team di turno:</strong> @currentAuction.CurrentTurnTeamName
                    </RadzenText>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                        <RadzenText>Nessuna asta attiva al momento</RadzenText>
                    </RadzenAlert>
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<!-- Assegnazioni Squadre -->
<RadzenRow Gap="2rem" Class="rz-p-4">
    <RadzenColumn Size="12">
        <RadzenCard>
            <RadzenStack>
                <RadzenText TextStyle="TextStyle.H5">
                    üë• Squadre e Assegnazioni
                </RadzenText>
                
                @if (teams == null)
                {
                    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                }
                else if (!teams.Any())
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                        <RadzenText>Nessuna squadra ancora configurata</RadzenText>
                    </RadzenAlert>
                }
                else
                {
            <RadzenDataGrid Data="@teams" TItem="TeamSummaryDto" AllowPaging="true" PageSize="10">
                        <Columns>
                <RadzenDataGridColumn TItem="TeamSummaryDto" Property="Name" Title="Squadra" />
                <RadzenDataGridColumn TItem="TeamSummaryDto" Property="PlayersCount" Title="Giocatori" />
                <RadzenDataGridColumn TItem="TeamSummaryDto" Property="AvailableBudget" Title="Budget" />
                        </Columns>
                    </RadzenDataGrid>
                }
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    [Inject] NavigationManager Navigation { get; set; } = default!;
    
    [Parameter] public Guid LeagueId { get; set; }
    private LeagueStatsDto? leagueInfo;
    private AuctionOverviewDto? currentAuction;
    private IReadOnlyList<TeamSummaryDto>? teams;

    protected override async Task OnInitializedAsync()
    {
        var grant = GrantAccessor.Current;
    if (grant == null || !grant.IsGuest || grant.LeagueId != LeagueId)
        {
            Navigation.NavigateTo("/", true);
            return;
        }
        if (LeagueId == Guid.Empty)
        {
            return; // Mostra solo spinner / TODO messaggio
        }
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        // TODO: Implementare chiamate ai servizi reali
    leagueInfo = await AuctionQueries.GetLeagueStatsAsync(LeagueId);
    currentAuction = await AuctionQueries.GetAuctionOverviewAsync(LeagueId);
    teams = await AuctionQueries.GetTeamsSummaryAsync(LeagueId);
    }

    
}
